<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>í”¼ë“œ ì‘ì„± - MaxFeed</title>
  <link href="https://cdn.jsdelivr.net/npm/water.css@2/out/light.min.css" rel="stylesheet">
  <style>
    .toast {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #333;
      color: #fff;
      padding: 10px 20px;
      border-radius: 8px;
      z-index: 9999;
      opacity: 0;
    }
  </style>
</head>
<body>

<h2>ìƒˆ í”¼ë“œ ì‘ì„±</h2>
<textarea id="content" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea><br>
<input type="file" id="file" multiple>
<button id="upload-btn" onclick="addFeed()">ì—…ë¡œë“œ</button>
<button onclick="location.href='index.html'">ì´ì „</button>

<script>
const api = 'https://supermax.kr/feed';

// âœ… í† ìŠ¤íŠ¸ ë©”ì‹œì§€ í‘œì‹œ í•¨ìˆ˜
function showToast(msg) {
  const toast = document.createElement('div');
  toast.className = 'toast';
  toast.innerText = msg;
  document.body.appendChild(toast);
  setTimeout(() => toast.style.opacity = 1, 10);
  setTimeout(() => {
    toast.style.opacity = 0;
    setTimeout(() => toast.remove(), 500);
  }, 2000);
}

// âœ… í”¼ë“œ ì—…ë¡œë“œ í•¨ìˆ˜
async function addFeed() {
  const fileInput = document.getElementById('file');
  const content = document.getElementById('content').value;
  const uploadBtn = document.getElementById('upload-btn');

  // âœ… ë²„íŠ¼ ì ê¸ˆ ë° UX
  uploadBtn.disabled = true;
  uploadBtn.innerText = 'â³ ì—…ë¡œë“œ ì¤‘...';

  if (!fileInput.files.length) {
    alert('íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”!');
    uploadBtn.disabled = false;
    uploadBtn.innerText = 'ì—…ë¡œë“œ';
    return;
  }

  const formData = new FormData();
  formData.append('content', content);
  for (let i = 0; i < fileInput.files.length; i++) {
    formData.append('files', fileInput.files[i]);
  }

  // âœ… í”¼ë“œ ì—…ë¡œë“œ ì•ˆë‚´
  showToast("â³ í”¼ë“œ ì—…ë¡œë“œ ì¤‘...");
  localStorage.setItem("pendingUpload", "true");

  try {
    const res = await fetch(`${api}/add-feed`, {
      method: 'POST',
      headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') },
      body: formData
    });

    if (res.ok) {
      const data = await res.json();
      console.log("âœ… ì—…ë¡œë“œ ì„±ê³µ:", data);

      // âœ… ì„±ê³µ í›„ ë©”ì¸ í˜ì´ì§€ë¡œ ì´ë™
      location.href = 'index.html';
    } else {
      const err = await res.json();
      alert("âŒ ì—…ë¡œë“œ ì‹¤íŒ¨: " + (err.error || "ì˜¤ë¥˜"));
      uploadBtn.disabled = false;
      uploadBtn.innerText = 'ì—…ë¡œë“œ';
    }

  } catch (err) {
    console.error("ğŸ”¥ ì—…ë¡œë“œ ì˜¤ë¥˜:", err);
    alert("âŒ ì—…ë¡œë“œ ì‹¤íŒ¨: " + err.message);
    uploadBtn.disabled = false;
    uploadBtn.innerText = 'ì—…ë¡œë“œ';
  }
}
</script>

</body>
</html>
